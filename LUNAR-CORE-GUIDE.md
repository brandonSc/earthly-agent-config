# Contributing to Lunar Core

Guide for AI agents contributing to the [earthly/lunar](https://github.com/earthly/lunar) repository.

---

## Before Starting

1. **Pull latest changes:**
   ```bash
   cd /home/brandon/code/earthly/lunar
   git checkout main && git pull
   ```

2. **Create a feature branch:**
   ```bash
   git checkout -b brandon/<feature-name>
   ```

---

## PR Requirements

### PR Title Format

**Always include the Linear ticket number in square brackets in the PR title:**

```
[ENG-XXX] Short description of the change
```

Examples:
- `[ENG-379] Fix agents getting stuck on 'configuration already exists' error`
- `[ENG-456] Add retry logic for manifest fetching`

### PR Description Template

```markdown
## Summary

Brief description of what this PR does and why.

## Changes

- Bullet points describing the specific changes made

## Related Issue

Fixes [ENG-XXX](https://linear.app/earthly-technologies/issue/ENG-XXX)

---

*This fix was generated by AI.*
```

**Important:** Always include the AI attribution line at the end of the description.

---

## Workflow

1. **Create Linear ticket first** — Document the bug/feature before starting work
2. **Create feature branch** — Use `brandon/<feature-name>` naming convention
3. **Make changes** — Keep changes minimal and focused
4. **Run tests locally** (if Go is available):
   ```bash
   go test ./...
   ```
5. **Commit with ticket reference:**
   ```bash
   git commit -m "[ENG-XXX] Description"
   ```
6. **Push and create draft PR:**
   ```bash
   git push -u origin brandon/<feature-name>
   gh pr create --draft --title "[ENG-XXX] Description" --body "..."
   ```
7. **Monitor CI** — Watch GitHub Actions for failures
8. **Open PR for review** — After CI passes:
   ```bash
   gh pr ready <pr-number>
   ```
9. **Assign reviewer** — Common reviewers:
   - **Nacho** → `idelvall`
   - **Mike** → `mikejholly`
   - **Vlad** → `vladaionescu`

---

## Code Style

- **Go formatting:** Run `gofmt` before committing
- **Add docstrings:** Functions should have comments explaining their purpose
- **Keep changes minimal:** Only modify what's necessary for the fix
- **Error handling:** Use `fmt.Errorf` with `%w` for error wrapping

---

## Architecture Notes

### CLI vs Hub

The lunar binary serves **two roles** — the CLI (`cmd/lunar`) and the Hub server (`cmd/lunar-hub`). When fixing bugs, understand which side your change affects:

- **CLI-side** changes (in `cmd/lunar/`) take effect when users install the new binary.
- **Hub-side** changes (in `hub/`) only take effect after the Hub server is redeployed. Use the **localdev** stack (see Testing section) to test hub-side changes locally without deploying to a remote environment.
- **Shared code** (in `snippets/`, `hubapi/`) may affect both sides.

When testing, always ask: "Does this fix run in the CLI or on the Hub?" If it's Hub-side, you need a deploy before you can verify end-to-end.

### SQL Queries

- SQL queries live in `hub/store/sql/` and are embedded via `//go:embed`.
- **Use parameterized queries** — always `$1`, `$2`, etc. Never hardcode values, even for testing. Hardcoded values in SQL files will get committed and break production.
- **LEFT JOINs produce NULLs** — if your query LEFT JOINs a table, the Go scan code must handle NULL columns using `sql.NullString`, `sql.NullTime`, `uuid.NullUUID`, etc.
- **Prefer pre-computed tables** — The `policy_run_rollups` table stores pre-derived status (`pass`/`fail`/`no-data`/`unknown`). Prefer reading from rollups over re-deriving status from raw `policy_assertions`. This keeps the CLI consistent with the UI (which also reads rollups via the `checks` view).

### Command Registration

CLI commands are defined in `cmd/lunar/main.go` (a large single file — this is intentional). Key patterns:
- Commands are `cobra.Command` vars registered in `setupFlags()` via `AddCommand()`.
- The `--help` text becomes user-facing documentation. Keep it accurate — no typos, match the docs site.
- The docs site at `docs-lunar.earthly.dev` is powered by `docs/lunar-cli/lunar-cli.md` via GitBook. When adding/renaming commands, update both the code AND the docs.

### Enforcement Levels

Policy enforcement levels control what gets blocked:

| Level | Blocks PR | Blocks Release |
|-------|-----------|----------------|
| `draft` | No | No |
| `score` | No | No |
| `report-pr` | No | No |
| `block-pr` | **Yes** | No |
| `block-release` | No | **Yes** |
| `block-pr-and-release` | **Yes** | **Yes** |

Enforcement is stored on the `snippets` table, not on policy results. When querying enforcement status, always join `snippets` to get the current enforcement level.

---

## Common Directories

| Directory | Purpose |
|-----------|---------|
| `snippets/fetch/` | Manifest fetching and caching |
| `hub/` | Hub server implementation |
| `hub/store/` | Database layer — SQL queries, store interfaces |
| `hub/store/sql/` | Embedded SQL query files |
| `hub/server.go` | gRPC server — handles CLI-to-Hub RPCs |
| `hub/webhook/` | GitHub webhook handling |
| `hub/queue/workers/` | Async job processing (policies, collectors) |
| `hub/migrations/` | Numbered SQL migration files (auto-run on startup) |
| `cmd/lunar/` | CLI binary (single large `main.go`) |
| `cmd/lunar-hub/` | Hub server binary |
| `snippets/` | Snippet execution engine |
| `hubapi/` | gRPC protobuf definitions |
| `docs/` | GitBook documentation source |

---

## Testing

### Building Locally

Go is not installed in this workspace. Use Earthly to build:
```bash
cd /home/brandon/code/earthly/lunar
earthly +build-cli    # builds dist/lunar-linux-amd64
earthly +build-hub    # builds the hub server
```

The built CLI binary can be used directly for testing:
```bash
./dist/lunar-linux-amd64 policy ok-release --help
```

### Local Testing

If Go is installed:
```bash
cd /home/brandon/code/earthly/lunar
go test ./...
```

### Localdev Testing (Preferred)

The **localdev** stack deploys hub, postgres, grafana, and supporting services locally via Docker Compose. This is the fastest way to test hub-side changes — no need to deploy to cronos or other demo environments.

**One-time setup:**

1. Create `localdev/.arg` with secrets (gitignored). Run this in a terminal where 1Password is authenticated:
   ```bash
   cat > /home/brandon/code/earthly/lunar/localdev/.arg <<EOF
   GITHUB_TOKEN=$(op item get lunar/localdev-github-token --reveal --vault cloud --fields password)
   NGROK_AUTHTOKEN=$(op item get ngrok/brandon-token --reveal --vault Employee --fields password)
   HUB_LOGS_AWS_ACCESS_KEY_ID=$(op item get lunar/localdev-logs-aws-access-key-id --reveal --vault cloud --fields password)
   HUB_LOGS_AWS_SECRET_ACCESS_KEY=$(op item get lunar/localdev-logs-aws-secret-access-key --reveal --vault cloud --fields password)
   LUNAR_MANIFEST_URL=github://pantalasa/lunar@localdev-brandon-main
   EOF
   chmod 600 /home/brandon/code/earthly/lunar/localdev/.arg
   ```

2. Install `yq` (required by the Earthfile):
   ```bash
   wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O ~/.local/bin/yq && chmod +x ~/.local/bin/yq
   ```

**Starting the stack:**

```bash
cd /home/brandon/code/earthly/lunar/localdev
export PATH="$HOME/.local/bin:$PATH"
earthly +localdev
```

This builds all images from source (including your local changes) and starts the compose stack. First run takes ~5-10 minutes; subsequent runs use caches.

**Connecting to the local hub:**

```bash
export LUNAR_HUB_HOST=localhost
export LUNAR_HUB_GRPC_PORT=8000
export LUNAR_HUB_HTTP_PORT=8001
export LUNAR_HUB_TOKEN=token
export LUNAR_HUB_INSECURE=true
```

**Testing SQL API:**

```bash
lunar sql connection-string
lunar sql refresh --full --overlap 48
# Connect to Postgres directly (from host, use localhost instead of postgres):
docker exec localdev-postgres-1 psql "postgres://sqlapi_user:testpassword@localhost:5432/hub?sslmode=disable" -c "\dt"
```

**Tearing down:**

```bash
earthly +localdev-down
```

**Localdev defaults:**

| Config | Value |
|--------|-------|
| `LUNAR_HUB_TOKEN` | `token` |
| `HUB_SQLAPI_USER_NAME` | `sqlapi_user` (default) |
| `HUB_SQLAPI_PASSWORD` | `testpassword` |
| `POSTGRES_USER` | `testuser` |
| `POSTGRES_PASSWORD` | `testpassword` |
| `POSTGRES_DB` | `hub` |
| Hub gRPC | `localhost:8000` |
| Hub HTTP | `localhost:8001` |
| Postgres | `localhost:5432` |
| Grafana | `localhost:3000` |

### Integration Testing (Demo Environments)

Use the pantalasa test environments to validate changes work end-to-end. Localdev is preferred for faster iteration; demo environments are for final verification before merge.

### QA Testing Discipline

When QA-ing a feature, follow these rules:

1. **Test both positive AND negative cases.** If a command can return pass/fail, you MUST verify both outcomes with real data. Never declare a feature working after only seeing one outcome.

2. **Test with appropriate inputs.** If a feature differentiates between branch types (PR vs main), test with both PR-branch SHAs and main-branch SHAs. Get real SHAs from `gh api repos/<org>/<repo>/pulls` and `gh api repos/<org>/<repo>/commits/main`.

3. **Verify results are correct for the right reason.** When a test passes, ask: *why* did it pass? If a command returns "blocked", is it because it actually evaluated failing policies, or because it found zero data? Check the code path.

4. **If two commands share code, test both.** A bug in `ok-release` likely exists in `ok-pr` since they use the same evaluation logic. Don't assume one works because the other appears to.

5. **Set up failing test scenarios first.** Before testing enforcement/blocking features, configure a policy that is *known to fail* for a test component (e.g., set `block-pr-and-release` with a disallowed license that exists in the SBOM). Confirm the failure shows in the UI, then verify the CLI catches it.

6. **Build a test matrix.** For features with multiple dimensions, enumerate all combinations:
   ```
   {ok-release, ok-pr} × {main SHA, PR SHA} × {passing policy, failing policy}
   ```
   Don't skip combinations — the bugs hide in the ones you skip.

---

## Known Quirks

- **`gh pr edit` fails** with a GraphQL "Projects (classic)" deprecation error. Use `gh api` instead:
  ```bash
  gh api repos/earthly/lunar/pulls/<number> -X PATCH -f title="..." -f body="..." --jq '.html_url'
  ```
- **CI `build-cli-mac` and `ci-images`** run on self-hosted runners that occasionally hit disk space or Docker issues. These failures are infra-related, not code-related.
- **CI "cache key" or "inconsistent graph state" errors** are Earthly bugs, not code issues. Re-run the failed CI job — it usually passes on retry. May need 2-3 attempts.
- **CI `hub-integration` Docker Hub timeouts** — The self-hosted runner sometimes can't pull images from Docker Hub (e.g., `net/http: timeout awaiting response headers`). Re-run the job.
- **CodeRabbit may skip draft PRs.** It often only reviews once the PR is marked ready, or after you comment `@coderabbitai review`.
- **Hub deploys are manual.** After merging Hub-side changes, someone needs to deploy to the demo environments (cronos, etc.). The deploy is done via deploy PRs like `Deploy cronos (#929)`.

---

## After Merge

1. **Monitor deployment** — Watch for issues in demo environments
2. **Close Linear ticket** — Mark as done after verification
