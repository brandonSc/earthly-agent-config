# Contributing to Lunar Core

Guide for AI agents contributing to the [earthly/lunar](https://github.com/earthly/lunar) repository.

---

## Before Starting

1. **Pull latest changes:**
   ```bash
   cd /home/brandon/code/earthly/lunar
   git checkout main && git pull
   ```

2. **Create a feature branch:**
   ```bash
   git checkout -b brandon/<feature-name>
   ```

---

## PR Requirements

### PR Title Format

**Always include the Linear ticket number in the PR title:**

```
ENG-XXX: Short description of the change
```

Examples:
- `ENG-379: Fix agents getting stuck on 'configuration already exists' error`
- `ENG-456: Add retry logic for manifest fetching`

### PR Description Template

```markdown
## Summary

Brief description of what this PR does and why.

## Changes

- Bullet points describing the specific changes made

## Related Issue

Fixes [ENG-XXX](https://linear.app/earthly-technologies/issue/ENG-XXX)

---

*This fix was generated by AI.*
```

**Important:** Always include the AI attribution line at the end of the description.

---

## Workflow

1. **Create Linear ticket first** — Document the bug/feature before starting work
2. **Create feature branch** — Use `brandon/<feature-name>` naming convention
3. **Make changes** — Keep changes minimal and focused
4. **Run tests locally** (if Go is available):
   ```bash
   go test ./...
   ```
5. **Commit with ticket reference:**
   ```bash
   git commit -m "ENG-XXX: Description"
   ```
6. **Push and create draft PR:**
   ```bash
   git push -u origin brandon/<feature-name>
   gh pr create --draft --title "ENG-XXX: Description" --body "..."
   ```
7. **Monitor CI** — Watch GitHub Actions for failures
8. **Open PR for review** — After CI passes:
   ```bash
   gh pr ready <pr-number>
   ```
9. **Assign reviewer** — Common reviewers:
   - **Nacho** → `idelvall`
   - **Mike** → `mikejholly`
   - **Vlad** → `vladaionescu`

---

## Code Style

- **Go formatting:** Run `gofmt` before committing
- **Add docstrings:** Functions should have comments explaining their purpose
- **Keep changes minimal:** Only modify what's necessary for the fix
- **Error handling:** Use `fmt.Errorf` with `%w` for error wrapping

---

## Architecture Notes

### CLI vs Hub

The lunar binary serves **two roles** — the CLI (`cmd/lunar`) and the Hub server (`cmd/lunar-hub`). When fixing bugs, understand which side your change affects:

- **CLI-side** changes (in `cmd/lunar/`) take effect when users install the new binary.
- **Hub-side** changes (in `hub/`) only take effect after the Hub server is redeployed. You cannot test Hub-side fixes locally — you need a deployed environment.
- **Shared code** (in `snippets/`, `hubapi/`) may affect both sides.

When testing, always ask: "Does this fix run in the CLI or on the Hub?" If it's Hub-side, you need a deploy before you can verify end-to-end.

### SQL Queries

- SQL queries live in `hub/store/sql/` and are embedded via `//go:embed`.
- **Use parameterized queries** — always `$1`, `$2`, etc. Never hardcode values, even for testing. Hardcoded values in SQL files will get committed and break production.
- **LEFT JOINs produce NULLs** — if your query LEFT JOINs a table, the Go scan code must handle NULL columns using `sql.NullString`, `sql.NullTime`, `uuid.NullUUID`, etc.
- **Prefer pre-computed tables** — The `policy_run_rollups` table stores pre-derived status (`pass`/`fail`/`no-data`/`unknown`). Prefer reading from rollups over re-deriving status from raw `policy_assertions`. This keeps the CLI consistent with the UI (which also reads rollups via the `checks` view).

### Command Registration

CLI commands are defined in `cmd/lunar/main.go` (a large single file — this is intentional). Key patterns:
- Commands are `cobra.Command` vars registered in `setupFlags()` via `AddCommand()`.
- The `--help` text becomes user-facing documentation. Keep it accurate — no typos, match the docs site.
- The docs site at `docs-lunar.earthly.dev` is powered by `docs/lunar-cli/lunar-cli.md` via GitBook. When adding/renaming commands, update both the code AND the docs.

### Enforcement Levels

Policy enforcement levels control what gets blocked:

| Level | Blocks PR | Blocks Release |
|-------|-----------|----------------|
| `draft` | No | No |
| `score` | No | No |
| `report-pr` | No | No |
| `block-pr` | **Yes** | No |
| `block-release` | No | **Yes** |
| `block-pr-and-release` | **Yes** | **Yes** |

Enforcement is stored on the `snippets` table, not on policy results. When querying enforcement status, always join `snippets` to get the current enforcement level.

---

## Common Directories

| Directory | Purpose |
|-----------|---------|
| `snippets/fetch/` | Manifest fetching and caching |
| `hub/` | Hub server implementation |
| `hub/store/` | Database layer — SQL queries, store interfaces |
| `hub/store/sql/` | Embedded SQL query files |
| `hub/server.go` | gRPC server — handles CLI-to-Hub RPCs |
| `hub/webhook/` | GitHub webhook handling |
| `hub/queue/workers/` | Async job processing (policies, collectors) |
| `hub/migrations/` | Numbered SQL migration files (auto-run on startup) |
| `cmd/lunar/` | CLI binary (single large `main.go`) |
| `cmd/lunar-hub/` | Hub server binary |
| `snippets/` | Snippet execution engine |
| `hubapi/` | gRPC protobuf definitions |
| `docs/` | GitBook documentation source |

---

## Testing

### Building Locally

Go is not installed in this workspace. Use Earthly to build:
```bash
cd /home/brandon/code/earthly/lunar
earthly +build-cli    # builds dist/lunar-linux-amd64
earthly +build-hub    # builds the hub server
```

The built CLI binary can be used directly for testing:
```bash
./dist/lunar-linux-amd64 policy ok-release --help
```

### Local Testing

If Go is installed:
```bash
cd /home/brandon/code/earthly/lunar
go test ./...
```

### Integration Testing

Use the pantalasa test environments to validate changes work end-to-end.

### QA Testing Discipline

When QA-ing a feature, follow these rules:

1. **Test both positive AND negative cases.** If a command can return pass/fail, you MUST verify both outcomes with real data. Never declare a feature working after only seeing one outcome.

2. **Test with appropriate inputs.** If a feature differentiates between branch types (PR vs main), test with both PR-branch SHAs and main-branch SHAs. Get real SHAs from `gh api repos/<org>/<repo>/pulls` and `gh api repos/<org>/<repo>/commits/main`.

3. **Verify results are correct for the right reason.** When a test passes, ask: *why* did it pass? If a command returns "blocked", is it because it actually evaluated failing policies, or because it found zero data? Check the code path.

4. **If two commands share code, test both.** A bug in `ok-release` likely exists in `ok-pr` since they use the same evaluation logic. Don't assume one works because the other appears to.

5. **Set up failing test scenarios first.** Before testing enforcement/blocking features, configure a policy that is *known to fail* for a test component (e.g., set `block-pr-and-release` with a disallowed license that exists in the SBOM). Confirm the failure shows in the UI, then verify the CLI catches it.

6. **Build a test matrix.** For features with multiple dimensions, enumerate all combinations:
   ```
   {ok-release, ok-pr} × {main SHA, PR SHA} × {passing policy, failing policy}
   ```
   Don't skip combinations — the bugs hide in the ones you skip.

---

## Known Quirks

- **`gh pr edit` fails** with a GraphQL "Projects (classic)" deprecation error. Use `gh api` instead:
  ```bash
  gh api repos/earthly/lunar/pulls/<number> -X PATCH -f title="..." -f body="..." --jq '.html_url'
  ```
- **CI `build-cli-mac` and `ci-images`** run on self-hosted runners that occasionally hit disk space or Docker issues. These failures are infra-related, not code-related.
- **CodeRabbit may skip draft PRs.** It often only reviews once the PR is marked ready, or after you comment `@coderabbitai review`.
- **Hub deploys are manual.** After merging Hub-side changes, someone needs to deploy to the demo environments (cronos, etc.). The deploy is done via deploy PRs like `Deploy cronos (#929)`.

---

## After Merge

1. **Monitor deployment** — Watch for issues in demo environments
2. **Close Linear ticket** — Mark as done after verification
