# Contributing to Lunar Core

Guide for AI agents contributing to the [earthly/lunar](https://github.com/earthly/lunar) repository.

---

## Before Starting

1. **Pull latest changes:**
   ```bash
   cd /home/brandon/code/earthly/lunar
   git checkout main && git pull
   ```

2. **Create a feature branch:**
   ```bash
   git checkout -b brandon/<feature-name>
   ```

---

## PR Requirements

### PR Title Format

**Always include the Linear ticket number in the PR title:**

```
ENG-XXX: Short description of the change
```

Examples:
- `ENG-379: Fix agents getting stuck on 'configuration already exists' error`
- `ENG-456: Add retry logic for manifest fetching`

### PR Description Template

```markdown
## Summary

Brief description of what this PR does and why.

## Changes

- Bullet points describing the specific changes made

## Related Issue

Fixes [ENG-XXX](https://linear.app/earthly-technologies/issue/ENG-XXX)

---

*This fix was generated by AI.*
```

**Important:** Always include the AI attribution line at the end of the description.

---

## Workflow

1. **Create Linear ticket first** — Document the bug/feature before starting work
2. **Create feature branch** — Use `brandon/<feature-name>` naming convention
3. **Make changes** — Keep changes minimal and focused
4. **Run tests locally** (if Go is available):
   ```bash
   go test ./...
   ```
5. **Commit with ticket reference:**
   ```bash
   git commit -m "ENG-XXX: Description"
   ```
6. **Push and create draft PR:**
   ```bash
   git push -u origin brandon/<feature-name>
   gh pr create --draft --title "ENG-XXX: Description" --body "..."
   ```
7. **Monitor CI** — Watch GitHub Actions for failures
8. **Open PR for review** — After CI passes:
   ```bash
   gh pr ready <pr-number>
   ```
9. **Assign reviewer** — Common reviewers:
   - **Nacho** → `idelvall`
   - **Mike** → `mikejholly`
   - **Vlad** → `vladaionescu`

---

## Code Style

- **Go formatting:** Run `gofmt` before committing
- **Add docstrings:** Functions should have comments explaining their purpose
- **Keep changes minimal:** Only modify what's necessary for the fix
- **Error handling:** Use `fmt.Errorf` with `%w` for error wrapping

---

## Common Directories

| Directory | Purpose |
|-----------|---------|
| `snippets/fetch/` | Manifest fetching and caching |
| `hub/` | Hub server implementation |
| `cmd/` | CLI commands |
| `collector/` | Collector runtime |
| `policy/` | Policy runtime |

---

## Testing

### Local Testing

If Go is installed:
```bash
cd /home/brandon/code/earthly/lunar
go test ./...
```

### Integration Testing

Use the pantalasa test environments to validate changes work end-to-end.

### QA Testing Discipline

When QA-ing a feature, follow these rules:

1. **Test both positive AND negative cases.** If a command can return pass/fail, you MUST verify both outcomes with real data. Never declare a feature working after only seeing one outcome.

2. **Test with appropriate inputs.** If a feature differentiates between branch types (PR vs main), test with both PR-branch SHAs and main-branch SHAs. Get real SHAs from `gh api repos/<org>/<repo>/pulls` and `gh api repos/<org>/<repo>/commits/main`.

3. **Verify results are correct for the right reason.** When a test passes, ask: *why* did it pass? If a command returns "blocked", is it because it actually evaluated failing policies, or because it found zero data? Check the code path.

4. **If two commands share code, test both.** A bug in `ok-release` likely exists in `ok-pr` since they use the same evaluation logic. Don't assume one works because the other appears to.

5. **Set up failing test scenarios first.** Before testing enforcement/blocking features, configure a policy that is *known to fail* for a test component (e.g., set `block-pr-and-release` with a disallowed license that exists in the SBOM). Confirm the failure shows in the UI, then verify the CLI catches it.

6. **Build a test matrix.** For features with multiple dimensions, enumerate all combinations:
   ```
   {ok-release, ok-pr} × {main SHA, PR SHA} × {passing policy, failing policy}
   ```
   Don't skip combinations — the bugs hide in the ones you skip.

---

## After Merge

1. **Monitor deployment** — Watch for issues in demo environments
2. **Close Linear ticket** — Mark as done after verification
